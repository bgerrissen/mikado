/**
 * @author Ben Gerrissen http://www.netben.nl/ bgerrissen@gmail.com
 * @license MIT
 * 
 * @version RC1
 * 
 * @todo
 * - unit tests
 * - test new killer mechanism properly
 * - investigate alternative for domBuild/domTool
 * - investigate expecting mikado.build to always return an Object or Function.
 * - backup script element load listeners to check if a script was loaded with no 'mikado.module' call inside.
 * - More proper error messages.
 * - Security messages?
 * - Module versions?
 * 
 * @notes
 * 
 * Still pondering about repository feature, it's far from understandable in current state.
 * Perhaps require that external repositories to always need the repo token to be set in module
 * definition paths? Another way is to superimpose the repo token to all dependencies.
 * 
 * Dropped mikado.use method, thats more YUI's thing!
 * 
 */
(function(){var j={},k={},h={},m={},u=[],n=0,v=this,i=v.document,A=i.getElementsByTagName("head")[0],g={timeout:1500,root:function(){for(var a=i.getElementsByTagName("script"),b=0,c=/\/mikado[^\/\\]*\.js.?$/i,d;d=a[b++];)if(c.test(d.src))return d.src.replace(c,"")}(),repositories:{},force:{}},w=i.createElement("script");w.type="text/javascript";var x=function(){},B=Array.prototype.slice,l={},f={add:function(a,b){l[a]||(l[a]=[]);l[a].unshift(b)},remove:function(a,b){a=l[a];var c;if(a)for(c=a.length;c--;)a[c]=== b&&a.splice(c,1)},dispatch:function(a,b){var c=l[a],d;if(c)for(d=c.length;d--;)c[d](b||a)}},p=function(a){u.push(a);f.dispatch("error",a)},y=function(){var a=function(b){if(b&&!b.nextSibling){i.body.removeChild(b);n=1;f.dispatch("domReady");return b=null}else if(b){i.body.removeChild(b);b=null}else if(i.body)b=i.body.appendChild(i.createElement("span"));setTimeout(function(){a(b)})};a();return function(b){n?b():f.add("domReady",b)}}();f.add("complete",function(a){var b=h[a.path];if(b&&b.length)for(var c= b.length,d,e;e=b[--c];)for(d=e.fetch.length;d&&d--;)if(e.fetch[d]==a.path){e.fetch.splice(d,1);if(!e.fetch.length){q(e);b.splice(c,1)}}});var C=function(a){for(var b in g.repositories)if(RegExp("^"+b).test(a))return g.repositories[b]+a.replace(/\./g,"/")+".js";return g.root+"/"+a.replace(/\./g,"/")+".js"},D=function(a){if(!a.fetch||!a.fetch.length)return false;for(var b=a.fetch,c=b.length,d;c--;){d=b[c];if(j[d])b.splice(c,1);else{h[d]||r(d,a.timeout);h[d].push(a)}}return true},r=function(a,b){if(j[a])return false; h[a]||(h[a]=[]);k[a]=w.cloneNode(false);k[a].src=C(a);A.appendChild(k[a]);f.dispatch("loading",{path:a,timeout:b?Math.max(b,g.timeout):g.timeout,stamp:(new Date).getTime()});return true},z=function(a,b){b=b||"TIMED OUT ["+a+"] @ "+m[a].timeout+"ms";p({message:b,resolution:"timeout",stamp:(new Date).getTime()});for(var c=h[a],d=c.length;d--;){z(c[d].path,b);delete c[d]}delete h[a]};f.add("loading",function(a){if(!g.timeout)return false;m[a.path]={timeout:a.timeout,timeoutID:setTimeout(function(){z(a.path)}, a.timeout)};return true});f.add("loaded",function(a){clearInterval(m[a.path].timeoutID);delete m[a.path]});var o=function(a){return a?a.split(".").pop():null},E=function(a){for(var b=a.length,c;b--;)if((c=o(a[b]))&&g.force[c])a[b]=g.force[c];return a},F=function(a){a.fetch=a.fetch||[];if(a.include instanceof Array)a.fetch=a.fetch.concat(a.include);return E(a.fetch)},G=function(a){if(a.allow instanceof Array){var b=a.allow,c;for(a.allow={};c=b.pop();)a.allow[c]=true}},H=function(a){var b=a.include, c=b.length,d=a.path,e,s;for(a.library={};c--;){s=b[c];e=j[s];if(e.allow&&!e.allow[d]){a.library[e.name]="Access denied!";p({message:"Disallowed acces from "+s+" to "+a.path,resolution:"continue",stamp:(new Date).getTime()})}else{a.hasDomTool=a.hasDomTool||e.domTool||e.hasDomTool||false;if(e.module)a.library[e.name]=e.module}}},I=function(a){var b=a.name||o(a.path),c=a.path||b;if(h[c])return true;var d=[],e;for(e in h)b==o(e)&&d.push(e);if(d.length===1)a.path=d[0];else{p({message:"could not resolve path '"+ c+"'",resolution:"fail",stamp:(new Date).getTime()});return false}return true},J=function(a){if(I(a)){a.name=a.name||o(a.path);G(a);F(a);f.dispatch("loaded",{path:a.path,stamp:(new Date).getTime()});D(a)||q(a)}},q=function(a){if(a.domBuild&&!n){y(function(){q(a)});return false}a.include instanceof Array&&H(a);if(typeof a.build=="function"){a.module=a.build(a.library);delete a.build}j[a.path]=a;f.dispatch("complete",{path:a.path,stamp:(new Date).getTime()});K(a.path)},K=function(a){delete h[a];k[a].parentNode.removeChild(k[a]); delete k[a]},t=function(a,b){if(a.hasDomTool&&!n)return y(function(){t(a,b)});var c=a.module;if(typeof c=="function"){x.prototype=c.prototype;var d=new x;c.apply(d,b)}};v.mikado={module:function(a){J(a)},run:function(a){var b=B.call(arguments,1),c=j[a];if(c)t(c,b);else{f.add("complete",function(d){if(d.path==a){t(j[a],b);f.remove("complete",arguments.callee)}});r(a)}return this},fetch:function(a,b){if(a instanceof Array)for(var c=a.length;c--;)r(a[c],b);return this},available:function(a){return!!j[a]}, config:function(a){for(var b in a)if(/(?:repositories|force)/.test(b))for(var c in a[b]){if(typeof a[b][c]=="string")g[b][c]=a[b][c]}else if(g[b])g[b]=a[b];return this},listen:function(a,b){f.add(a,b);return this},deafen:function(a,b){f.remove(a,b);return this},getErrorLog:function(){return u}}})();