/**
 * @author Ben Gerrissen http://www.netben.nl/ bgerrissen@gmail.com
 * @license MIT
 * 
 * todo: proper documentation!
 * 
 */

var mikado=function(){var X={};var E=false;var a={timeout:1500,root:(function(){var d=document.getElementsByTagName("script"),f=/\/mikado[^\/\\]*\.js.?$/i,e=d.length,g;while(e--){g=d[e].src;if(f.test(g)){return g.replace(f,"")}}return""})(),scriptLocation:document.getElementsByTagName("head")[0],repositories:{},force:{}};var Y=document.createElement("script");Y.type="text/javascript";var F={};var L=(function(f,d){try{var g=Array.prototype.slice.call(arguments);if(g.length===2&&g[0]===1&&g[1]===2){return function(e,j){return Array.prototype.slice.call(e,j)}}}catch(h){}return function(k,m){var j=[],l=0,e=k.length;for(l;l<e;l++){j.push(k[l])}return j.slice(m)}})(1,2);function c(){var d={};return{add:function(e,f){if(!d[e]){d[e]=[]}d[e].push(f)},remove:function(f,h){if(!f){return }if(!h&&d[f]){delete d[f];return }var g=d[f],e;if(g&&h){e=g.length;while(e--){if(g[e]===h){g.splice(e,1)}}}},dispatch:function(g,j){var h=d[g],e,f;if(h){for(e=0,f=h.length;e<f;e++){h[e](g)}}}}}var O=(function(){var e=c();function d(f){if(f&&!f.nextSibling){f=document.body.removeChild(f);f=null;E=true;return e.dispatch("domReady")}else{if(f){document.body.removeChild(f);f=null}else{if(document.body){f=document.body.appendChild(document.createElement("span"))}}}setTimeout(function(){d(f)})}d();return function(f){if(!E){e.add("domReady",f)}else{f()}}})();var H={};var T=c();function B(d){if(!d.fetch){return }var g=d.fetch,h,e;d.dependencyListener=function(k){var j=g.length;while(j--){if(g[j]===k){g.splice(j,1)}}if(!g.length){J(d);T.remove(k,d.dependencyListener)}};var f=g.length;while(f--){h=g[f];if(X[h]){g.splice(f,1);continue}if(!H[h]){H[h]=[]}H[h].push(d);N(h,d.timeout);T.add(h,d.dependencyListener)}}function N(e,d){if(!H[e]){H[e]=[]}F[e]=Y.cloneNode(true);F[e].src=W(e);a.scriptLocation.appendChild(F[e]);G(e,d)}var b={};function G(e,d){if(!a.timeout){return }d=d?Math.max(a.timeout,d):a.timeout;b[e]={timeout:d,timeoutId:setTimeout(function(){delete H[e];F[e].type="TIMED OUT ['"+e+"'] @ "+d+"ms"},d)}}function D(d){if(b[d]&&a.timeout){clearTimeout(b[d].timeoutId)}}function V(e){if(!a.timeout){return }D(e);var f=b[e];O(function(){G(e,f.node,f.timeout)});var d=H[e].length;while(i--){V(H[e][d].path)}}function A(g){var f=0,d=g.length,h,e;for(f;f<d;f++){h=g[f];e=S(h);if(a.force[e]){g[f]=a.force[e]}}return g}function S(d){return d?d.split(".").pop():""}function W(f){if(/^.*:/.test(f)){var e=f.replace(/:.*$/,"");var d=a.repositories[e];f=f.replace(/^.*:/,"").replace(/\./g,"/")+".js";if(!d){throw"Error @ mikado->internal 'createFullPath' : No repository set for '"+e+":'"}return d+f}else{return a.root+"/"+f.replace(/\./g,"/")+".js"}}function U(d){d.fetch=d.fetch||[];if(d.include instanceof Array){d.fetch=d.fetch.concat(d.include)}A(d.fetch)}function I(d){if(d.allow instanceof Array){var f,e=d.allow;d.allow={};while(f=e.pop()){d.allow[f]=true}}}function K(f){var h=f.include,g=h.length,e,j,d=f.path;f.lib={};while(g--){j=h[g];e=X[j];if(e.allow&&!e.allow[d]){f.lib[e.name]="Access denied!";continue}f.hasDomTool=f.hasDomTool||e.domTool||e.hasDomTool;f.lib[e.name]=e.module}}function C(d){var e=d.name||S(d.path);var h=d.path||e;if(!e){throw"ERROR: loaded module does not contain a required 'path' or optional 'name' setting!!"}if(!H[h]){var g=[];for(var f in H){if(e==S(f)){g.push(f)}}if(g.length==1){d.path=g[0]}else{throw"ERROR: could not resolve incorrect path: '"+h+"'"}}}function M(d){C(d);d.name=S(d.path);I(d);U(d);B(d);if(!d.fetch.length){J(d)}}function J(d){if(d.domBuild&&!E){V(V(d.path));return O(function(){J(d)})}if(d.include instanceof Array){K(d)}d.module=d.build(d.lib);X[d.path]=d;Q(d.path);T.dispatch(d.path)}function Q(d){delete H[d];D(d);delete b[d];F[d].parentNode.removeChild(F[d]);delete F[d]}function P(){}function Z(e,f){var g=e.module;if(e.hasDomTool&&!E){O(function(){Z(e,f)});return }if(typeof g=="function"){P.prototype=g.prototype;var d=new P();g.apply(d,f)}}var R={module:function(d){M(d)},run:function(f){var e=L(arguments,1),d=X[f];if(!d){T.add(f,function(g){Z(X[g],e)});N(f)}else{Z(d,e)}return this},fetch:function(f,e){if(f instanceof Array){var d=f.length;while(i--){N(f[d],e)}}return this},use:function(){var g=L(arguments),e=g.length,f,l,k,j={},d;var h=function(n){var m=g.length;while(m--){if(g[m]===n){g.splice(m,1)}}j[X[n].name]=X[n].module;d=d||X[n].domTool||X[n].hasDomTool;if(!g.length){T.remove(n,h);if(l&&(!d||E)){l(j)}else{if(l&&!E){O(function(){l(j)})}}}};while(e--){if(typeof g[e]=="string"){N(g[e]);T.add(g[e],h);continue}if(!isNaN(g[e])&&f===k){f=g.splice(e,1)[0]}else{if(g[e] instanceof Function&&!l){l=g.splice(e,1)[0]}else{g.splice(e,1)}}}return this},settings:function(f){for(var e in f){if(/(?:repositories|force)/.test(e)){for(var d in f[e]){if(typeof f[e][d]=="string"){a[e][d]=f[e][d]}}}else{if(a[e]){a[e]=f[e]}}}return this}};return R};mikado=mikado();