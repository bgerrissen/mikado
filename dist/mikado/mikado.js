/**
 * @author Ben Gerrissen http://www.netben.nl/ bgerrissen@gmail.com
 * @license MIT
 * 
 * @version RC2
 * 
 * @todo
 * - unit tests
 * - investigate alternative for domBuild/domTool
 * - investigate expecting mikado.build to always return an Object or Function.
 * - More proper error messages.
 * - Security messages?
 * - Module versions?
 * 
 */
(function(){var i={},K={},J={},G={},Z=[],W=0,U=this,O=U.document,g=O.documentElement,V=O.getElementsByTagName("head")[0],X={timeout:1500,root:function(){var p=O.getElementsByTagName("script"),m=0,n=/\/mikado[^\/\\]*\.js.?$/i,o;while((o=p[m++])){if(n.test(o.src)){return o.src.replace(n,"")}}}(),repositories:{},force:{}},e=O.createElement("script");e.type="text/javascript";var B=function(){},L=Array.prototype.slice,M=function(n,o){if(o){for(var m in o){n[m]=o[m]}}return n},f={},R={listen:function(m,n){if(!f[m]){f[m]=[]}f[m].unshift(n)},deafen:function(n,p){var o=f[n],m;if(o){m=o.length;while(m--){if(o[m]===p){o.splice(m,1)}}}},dispatch:function(n,p){var o=f[n],m;var p=p||{};p.type=n;if(o){m=o.length;while(m--){o[m](p)}}}},Y=function(m,n){this.type=m||this.type;this.timestamp=+new Date();M(this,n)};Y.prototype={type:"none",message:null,resolution:null,path:null};M(Y,{COMPLETE:"complete",LOADING:"loading",LOADED:"loaded",ERROR:"error",DOMREADY:"domReady",RUN:"run",RAN:"ran"});var I=function(m,n){var o=new Y(m,n);Z.push(o);R.dispatch(m,o)},T=function(){if(!W){W=1;R.dispatch(Y.DOMREADY)}};if(O.addEventListener){var S=function(){T();O.removeEventListener("DOMContentLoaded",arguments.callee,false);O.removeEventListener("load",arguments.callee,false)};O.addEventListener("DOMContentLoaded",S,false);O.addEventListener("load",S,false)}else{if(O.attachEvent){var H=0;var a=function(){try{g.doScroll("left");H=g.outerHTML.length;if(H*1.03<O.fileSize*1){return setTimeout(a,50)}}catch(m){return setTimeout(a,50)}T()};var h=function(){if(O.readyState!="complete"){a()}else{T()}O.detachEvent("onreadystatechange",arguments.callee);O.detachEvent("load",arguments.callee)};O.attachEvent("onreadystatechange",h);O.attachEvent("load",h)}else{var k=U.onload;U.onload=function(m){T();if(typeof k=="function"){k(m||U.event)}}}}R.listen(Y.COMPLETE,function(q){var o=J[q.path];if(!o||!o.length){return }var n=o.length,m,p;while((p=o[--n])){m=p.fetch.length;while(m&&m--){if(p.fetch[m]!=q.path){continue}p.fetch.splice(m,1);if(!p.fetch.length){l(p);o.splice(n,1)}}}});var c=function(n){for(var m in X.repositories){if(RegExp("^"+m).test(n)){return X.repositories[m]+n.replace(/\./g,"/")+".js"}}return X.root+"/"+n.replace(/\./g,"/")+".js"},b=function(m){if(!m.fetch||!m.fetch.length){return false}var o=m.fetch,n=o.length,p;while(n--){p=o[n];if(i[p]){o.splice(n,1);continue}if(!J[p]){J[p]=[]}J[p].push(m)}C(o,m.timeout);return o.length?true:false},C=function(q,p){var o=q.length,m,r,n=document.createDocumentFragment();while(o--){r=q[o];K[r]=e.cloneNode(true);K[r].src=c(r);n.appendChild(K[r]);I(Y.LOADING,{path:r,timeout:p})}V.appendChild(n)},N=function(q,n){var p=n?"Dependency '"+q+"'":"";n=n||"Timed out @ "+G[q].timeout+"ms";I(Y.ERROR,{path:q,message:n,resolution:"failed silently"});var o=J[q],m=o.length;while(m--){N(o[m].path,n);delete o[m]}delete J[q]};R.listen(Y.LOADING,function(m){if(!X.timeout){return false}G[m.path]={timeout:m.timeout,timeoutID:setTimeout(function(){N(m.path)},m.timeout)};return true});R.listen(Y.LOADED,function(m){if(G[m.path]){clearInterval(G[m.path].timeoutID);delete G[m.path]}});var j=function(m){return m?m.split(".").pop():null},F=function(o){var n=o.length,m;while(n--){m=j(o[n]);if(m&&X.force[m]){o[n]=X.force[m]}}return o},P=function(m){m.fetch=m.fetch||[];if(m.include instanceof Array){m.fetch=m.fetch.concat(m.include)}return F(m.fetch)},D=function(m){if(m.allow instanceof Array){var n=m.allow,o;m.allow={};while((o=n.pop())){m.allow[o]=true}}},d=function(o){var q=o.include,p=q.length,n=o.path,m,r;o.library={};while(p--){r=q[p];m=i[r];if(m.allow&&!m.allow[n]){o.library[m.name]="Access denied!";I(Y.ERROR,{path:o.path,message:"Disallowed acces to '"+r+"'",resolution:"failed silently"});continue}if(m.traits.domTool){o.traits.domTool=true}if(m.module){o.library[m.name]=m.module}}},Q=function(m){m.name=m.name||j(m.path);m.traits=m.traits||{};m.traits.path=m.path;m.traits.name=m.name;m.timeout=m.timeout?Math.max(timeout,X.timeout):X.timeout;D(m);P(m);I(Y.LOADED,m.traits);if(!b(m)){l(m)}},l=function(m){if(m.traits.domBuild&&!W){R.listen(Y.DOMREADY,function(){l(m)});return false}if(m.include instanceof Array){d(m)}if(typeof m.build=="function"){try{m.module=m.build(m.library);delete m.build}catch(n){I(Y.ERROR,{error:n,path:m.path,message:"failed to build module",resolution:"failed silently"})}}i[m.path]=m;I(Y.COMPLETE,m.traits)};R.listen(Y.COMPLETE,function(m){if(K[m.path]){K[m.path].parentNode.removeChild(K[m.path])}delete J[m.path];delete K[m.path]});var A=function(n,o){if(n.traits.domTool&&!W&&!n.traits.domIgnore){R.listen(Y.DOMREADY,function(){A(n,o)});return }var p=n.module;if(typeof p=="function"){I(Y.RUN,n.traits);B.prototype=p.prototype;var m=new B();p.apply(m,o);I(Y.RAN,n.traits)}else{I(Y.ERROR,{path:n.path,message:"Nothing is run @ '"+n.path+"'",resolution:"failed silently"})}},E={module:function(m){Q(m)},run:function(o){var n=L.call(arguments,1),m=i[o];if(!m){R.listen(Y.COMPLETE,function(p){if(p.path==o){A(i[o],n);R.deafen(Y.COMPLETE,arguments.callee)}});C([o],X.timeout)}else{A(m,n)}return this},fetch:function(o,n){if(!(o instanceof Array)){return this}var m=o.length;while(m--){if(J[o[m]]){o.splice(m,1)}}if(o.length){C(o,n)}return this},available:function(m){return !!i[m]},config:function(o){for(var n in o){if(/(?:repositories|force)/.test(n)){for(var m in o[n]){if(typeof o[n][m]=="string"){X[n][m]=o[n][m]}}}else{if(X[n]){X[n]=o[n]}}}return this},listen:function(m,n){R.listen(m,n);return this},deafen:function(m,n){R.deafen(m,n);return this},getLog:function(p){var o=new RegExp("^(?:"+L.call(arguments).join("|")+")$");var m=Z.length,n=[];while(m--){if(o.test(Z[m].type)||!p){n.unshift(Z[m])}}return n}};U.mikado=E})();